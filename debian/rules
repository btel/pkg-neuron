#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This has to be exported to make some magic below work.
# export DH_OPTIONS

CFLAGS = -Wall -g
ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -O0
else
	CFLAGS += -O2
endif
export CFLAGS

# Default Python version which is supported
PYVER=$(shell pyversions --default)

%:
	dh $@

# Override parameters for configure
#   --with-music necessary ATM to have CYTHON defined even for
#                just getting a source distribution out
#   --without-mpi  -- MPI builds should be done later on
override_dh_auto_configure:
	./build.sh
	NSRC=$$PWD dh_auto_configure -- \
	 --with-nrnpython=/usr/bin/python \
	 --with-music=/usr \
	 --with-iv=/usr \
	 --exec_prefix=/usr \
	 --without-mpi

#override_dh_auto_build:
#	dh_auto_build
#	dh_auto_build -Dsrc/neuronmusic --buildsystem=python_distutils
#	dh_auto_build -Dsrc/nrnpython --buildsystem=python_distutils

override_dh_auto_install:
	dh_auto_install
	dh_auto_install --destdir=debian/python-neuron -Dsrc/neuronmusic --buildsystem=python_distutils
	dh_auto_install --destdir=debian/python-neuron -Dsrc/nrnpython --buildsystem=python_distutils
	install --mode=644 share/lib/python/rdxml.py debian/python-neuron/usr/lib/$(PYVER)/dist-packages

override_dh_install:
	dh_install
	rm -rf debian/neuron-common/usr/share/nrn/lib/python
	# Figure out if necessary at all
	# ln -sf /usr/share/pyshared/neuron debian/neuron-common/usr/share/nrn/lib/python/
	# ln -sf /usr/share/pyshared/rdxml.py debian/neuron-common/usr/share/nrn/lib/python/rdxml.py

# This compares against original source tree, not debian/tmp
#override_dh_install:
#	dh_install --list-missing

override_dh_strip:
	# Can't use --dbg-package because we have multiple debug packages
	dh_strip -k

	mv debian/neuron/usr/lib/debug debian/neuron-dbg/usr/lib/
	mv debian/libneuron*/usr/lib/debug/usr/* debian/neuron-dbg/usr/lib/debug/usr/
	rm -rf debian/libneuron*/usr/lib/debug

	mv debian/python-neuron/usr/lib/debug debian/python-neuron-dbg/usr/lib
	cd debian/python-neuron-dbg/usr/lib/debug/usr/lib && mv pyshared pymodules



# TODO: more
override_dh_auto_clean:
	dh_auto_clean
	[ ! -f Makefile ] || $(MAKE) clean
	[ ! -f Makefile ] || $(MAKE) maintainer-clean	# since we are autogening everything
	-find -iname Makefile.in -delete # and those too
	-rm -r `arch`				# TODO per-arch
	-rm ylwrap aclocal.m4 depcomp missing install-sh ltmain.sh src/nrnoc/hocusr.h
	-rm configure config.* *.h.in
	-rm m4/ltsugar.m4 m4/ltversion.m4 m4/lt~obsolete.m4 m4/ltoptions.m4 m4/libtool.m4
